//IntrinsicAttributes
import IFrame from "./IFrame";
import './MainScreen.css'
import { MouseEventHandler, useEffect, useState } from "react";
import { Button, InputAdornment, OutlinedInput } from "@material-ui/core"
import { TransactionEnum } from '../Enum/TransactionEnum'
import { useTranslation } from "react-i18next";
import { namespaces } from "../i18n/i18n.constants";
import { i18n } from '../i18n/i18n';
import imageFile from "../images/payment.jpg";
import { fetchToken, onMessageListener } from './Firebase';
import { Toast } from 'react-bootstrap';

const IframeParent = () => {

    useEffect(() => {
        window.addEventListener("message", function (e) {
            if (e.origin !== 'http://localhost:3001') return;
            console.log("Recived from APP2:" + e.data)
            if (e.data === TransactionEnum.success) {
                console.log("from succes")
                setInputValue("")
                setButtonProperty(prevValues => {
                    return { ...prevValues, text: "Payment Successful" }
                })
                AfterTransaction()
            }
            else{
                setButtonProperty(prevValues => {
                    return { ...prevValues, text: "Payment Failed" }
                })
                AfterTransaction()
            }
        })
    }, []);

    //FCM Token for client

    const [show, setShow] = useState(false);
    const [notification, setNotification] = useState({ title: '', body: '' });
    const [isTokenFound, setTokenFound] = useState(false);
   //getting token client from Firebase.ts

    onMessageListener().then((payload: any) => {
        console.log("Payload from firebase"+payload)
        setNotification({ title: payload.notification.title, body: payload.notification.body })
        setShow(true);
        console.log(payload);
    }).catch(err => console.log('failed: ', err));

    const onShowNotificationClicked = () => {
        fetchToken(setTokenFound);
        setNotification({ title: "Notification", body: "This is a test notification triggered via state" })
        setShow(true);
    }

    //Translation
    const { t } = useTranslation(namespaces.pages.hello);

    const changeLanguage = (language: string) => () => {
        i18n.changeLanguage(language);
    };

    //Payment Input
    const [toggle, setToggle] = useState<boolean>(false);
    const [inputValue, setInputValue] = useState<string>("")
    const [buttonProperty, setButtonProperty] = useState({
        'text': "Make Payment",
    })

    const ToggleElements: MouseEventHandler<HTMLButtonElement> | undefined = () => {
        setToggle(prevState => !prevState)
    }

    function AfterTransaction() {
        setToggle(false)
        setTimeout(() => {
            setButtonProperty(prevValues => {
                return { ...prevValues, text: "Make Payment" }
            })
        }, 3000)
    }

    return (
        <div className=".main">
            <div>
                <Toast onClose={() => setShow(true)} show={show} delay={3000} autohide animation style={{
                    position: 'absolute',
                    top: 20,
                    right: 20,
                    minWidth: 200
                }}>
                    <Toast.Header>
                        <img
                            src="holder.js/20x20?text=%20"
                            alt=""
                        />
                        <strong >{notification.title}</strong>
                        {/* <small>just now</small> */}
                    </Toast.Header>
                    <Toast.Body >{notification.body}</Toast.Body>
                </Toast>
                <header className="App-header">
                    {
                        isTokenFound==true?
                        <h1> Notification permission enabled üëç</h1>
                        :
                        <h1> Need notification permission üôã </h1>
                    }
                    <button onClick={onShowNotificationClicked}>Test Local notification</button>
                </header>
            </div>

            <Button style={{ position: "fixed", top: "30px", right: "45px" }} variant="contained" color="secondary">
                Subscribe
            </Button>
            <h1 style={{ color: "blue" }}>{t("welcome", { ns: namespaces.pages.hello })}</h1>
            <Button onClick={changeLanguage("en")}>English</Button>
            <Button onClick={changeLanguage("hi")}>‡§π‡§ø‡§Ç‡§¶‡•Ä</Button>
            <br></br>
            <img src={imageFile} alt="image" style={{ width: "30%", height: "30%" }} />
            <br></br>
            {
                toggle === true ?
                    <IFrame
                        inputValue={inputValue}
                    />
                    :
                    <>
                        <OutlinedInput
                            className="nextLine"
                            id="outlined-adornment-weight"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            aria-describedby="outlined-weight-helper-text"
                            inputProps={{
                                'aria-label': 'weight',
                            }}
                            startAdornment={<InputAdornment position="start">‚Çπ</InputAdornment>}
                        />
                        <br></br>
                        <Button variant="outlined" color="primary" id="sendMessageButton" onClick={ToggleElements}>{buttonProperty.text}</Button>
                    </>
            }
        </div>
    )
}
export default IframeParent;